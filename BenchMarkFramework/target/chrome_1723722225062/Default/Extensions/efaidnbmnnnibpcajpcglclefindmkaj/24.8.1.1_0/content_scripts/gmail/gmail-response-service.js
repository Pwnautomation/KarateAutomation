/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{sendAnalytics}from"./util.js";import{processForListView}from"./list-view-touch-point-service.js";import state from"./state.js";const PDF_MIME_TYPE="application/pdf";let userId="";const getUserId=()=>{if(""===userId){const e=window?.location?.pathname.split("/");userId=e.length>3?e[3]:"0"}return userId},getAttachmentURL=e=>{let t=e.replace("&disp=safe","")+"&disp=inline";return getUserId()&&(t=t.replace("/mail/?",`/mail/u/${getUserId()}/?`)),t},acrobatMailDataHandler=e=>{let t;e?.detail?.url?.includes("/fd")?t=parseFDResponse(e?.detail?.responseData):e?.detail?.url?.includes("/i/s")?t=parseISResponse(e?.detail?.responseData):e?.detail?.url?.includes("/bv")?t=parseBVResponse(e?.detail?.responseData):e?.detail?.url?.includes("gmSetData")&&(t=parseGMSetData(e?.detail?.responseData,e?.detail?.key)),updateExistingThreadData(t,!0),processForListView()},addMailDataEventListener=()=>{document.addEventListener("acrobat-mail-data",(e=>{setTimeout((()=>{acrobatMailDataHandler(e)}),0)}),{signal:state?.eventControllerSignal})},injectResponseListenerScript=()=>{if(state?.gmailResponseListenerAdded)return;const e=document.createElement("script");e.setAttribute("id","acrobat-response-interceptor"),e.src=chrome.runtime.getURL("content_scripts/gmail/gmail-inject.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e),state.gmailResponseListenerAdded=!0},updateExistingThreadData=(e,t)=>{e&&Object.keys(e).forEach((s=>{const a=e[s].messages,r={id:s,messages:{...state.getMessagesForThreadId(s)||{},...a}};t?state.setDataForThread(r):e[e]=r}))},parseISAttachments=e=>{try{const t=[];if(Array.isArray(e))for(let s of e)if(s[0]===PDF_MIME_TYPE){const e=getAttachmentURL(s[5]);t.push({name:s[1],url:e})}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:ISAParsingFailed:${e.message}`]]),null}},parseISDriveAttachments=e=>{try{const t=[],s=e[12]?.[28];if(Array.isArray(s))for(let e of s)if(e[4]===PDF_MIME_TYPE){const s=e[5];t.push({name:e[1],url:s,isDriveAsset:!0})}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:ISDAParsingFailed:${e.message}`]]),null}},parseFDAttachments=e=>{try{const t=[];if(Array.isArray(e))for(let s of e){const e=s[0]?.[3]||"";if(e?.length>0||e[3]===PDF_MIME_TYPE){const s=getAttachmentURL(e[1]);t.push({name:e[2],url:s})}}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:FDAParsingFailed:${e.message}`]]),null}},parseISEmailAndUpdateThreadData=(e,t,s)=>{if(e?.length>0)try{for(let a of e){const e=a[0],r=a[6],n=parseISAttachments(a[11]),i=parseISDriveAttachments(a);if(n?.length>0||i?.length>0){const l=a[71]&&9===a[71][0];t[s]||(t[s]={messages:{}}),t[s].messages[e]={id:e,timestamp:r,deleted:l,attachments:n,driveAttachments:i}}}}catch(e){sendAnalytics([[`DCBrowserExt:Gmail:ISEmailsParsingFailed:${e.message}`]])}},parseGMSetData=(e,t)=>{try{const s=JSON.parse(e);if(!Array.isArray(s))return;const a="Cl6csf"===t?s[1]:s[0]?.[0];if(!a||!Array.isArray(a))return null;const r={};for(let e of a)if("Cl6csf"===t){const t=e[1]?.[3],s=e[1]?.[4];parseISEmailAndUpdateThreadData(s,r,t)}else{const t=e[1],s=e[4]?.[4];parseGMSetDataA6JDVEmails(s,r,t)}return r}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:GMResponseParsingFailed:${e.message}`]]),null}},parseBVResponse=e=>{try{const t=JSON.parse(e)[2];if(!t||!Array.isArray(t))return null;const s={};for(let e of t){const t=e[0][3],a=e[0]?.[4];parseISEmailAndUpdateThreadData(a,s,t)}return s}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:BVResponseParsingFailed:${e.message}`]]),null}},parseISResponse=e=>{try{const t=JSON.parse(e)[1]?.[5];if(!t||!Array.isArray(t))return null;const s={};for(let e of t){const t=e[0]?.[0],a=e[0]?.[2]?.[6]?.[0]?.[4];parseISEmailAndUpdateThreadData(a,s,t)}return s}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:ISResponseParsingFailed:${e.message}`]]),null}},parseFDDriveAttachments=e=>{try{const t=[],s=e[1]?.[5]?.[1]?.[0]?.[2]?.[1];if(s&&s.includes("drive.google.com")){const e=Document.parseHTMLUnsafe(s).querySelectorAll(".gmail_chip.gmail_drive_chip>a");if(e?.length>0)for(let s of e){const e=s.getAttribute("href"),a=s.querySelector("span")?.textContent;a?.toLowerCase().endsWith(".pdf")&&t.push({name:a,url:e,isDriveAsset:!0})}}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:FDDAParsingFailed:${e.message}`]]),null}},parseA6JDVDriveAttachments=e=>{try{let t=[];const s=e[12]?.[28];if(Array.isArray(s))for(let e of s){if(e[4]!==PDF_MIME_TYPE)continue;const s=e[5];t.push({name:e[1],url:s})}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:A6JDVDriveAttParsingFailed:${e.message}`]]),null}},parseA6JDVAttachments=e=>{try{let t=[];if(Array.isArray(e[11]))for(let s of e[11]){if(s[0]!==PDF_MIME_TYPE)continue;let e=getAttachmentURL(s[5]);t.push({name:s[1],url:e})}return t}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:A6JDVAttParsingFailed:${e.message}`]]),null}},parseGMSetDataA6JDVEmails=(e,t,s)=>{if(e&&Array.isArray(e))try{for(let a of e){const e=a[0],r=a[6],n=parseA6JDVAttachments(a),i=parseA6JDVDriveAttachments(a);if(n?.length>0||i?.length>0){const l=9===a[71]?.[0];t[s]||(t[s]={messages:{}}),t[s].messages[e]={id:e,attachments:n,driveAttachments:i,timestamp:r,deleted:l}}}}catch(e){sendAnalytics([[`DCBrowserExt:Gmail:GMSetDataA6JDV:${e.message}`]])}},parseFDEmailAndUpdateThreadData=(e,t,s)=>{if(Array.isArray(e))try{for(let a of e){const e=a[0],r=parseFDAttachments(a[1]?.[13]),n=parseFDDriveAttachments(a);if(r?.length>0||n?.length>0){const i=a[1]&&a[1][38]&&9===a[1][38][0];t[s]||(t[s]={messages:{}}),t[s].messages[e]={id:e,attachments:r,driveAttachments:n,timestamp:a[1]?.[16],deleted:i}}}}catch(e){sendAnalytics([[`DCBrowserExt:Gmail:FDEmailsParsingFailed:${e.message}`]])}},parseFDResponse=e=>{try{const t=JSON.parse(e)[1];if(!t||!Array.isArray(t))return null;const s={};for(let e of t){const t=e[0],a=e[2];parseFDEmailAndUpdateThreadData(a,s,t)}return s}catch(e){return sendAnalytics([[`DCBrowserExt:Gmail:FDResponseParsingFailed:${e.message}`]]),null}};state?.gmailConfig.enableListViewPromptInGmail&&(injectResponseListenerScript(),document.addEventListener("acrobat-mail-data",(e=>{setTimeout((()=>{acrobatMailDataHandler(e)}),0)}),{signal:state?.eventControllerSignal}));